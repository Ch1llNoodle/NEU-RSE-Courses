/**
 * brief:DAC 波形发生
 * author:李昊佳
 * data 2019-12-23
 * */
#include <reg52.h>

xdata unsigned char DA0832 _at_ 0xA000;
#define DATA_TIME 156 //定时器延时  50hz的频率


sbit S1 = P1 ^ 0;
sbit S2 = P1 ^ 1;
//00锯齿波；01方波；10三角波；11正弦波

unsigned char code sin_tab[] = //正弦波输出表
	{
		0x80, 0x83, 0x86, 0x89, 0x8D, 0x90, 0x93, 0x96, 0x99, 0x9C, 0x9F, 0xA2, 0xA5, 0xA8, 0xAB, 0xAE,
		0xB1, 0xB4, 0xB7, 0xBA, 0xBC, 0xBF, 0xC2, 0xC5, 0xC7, 0xCA, 0xCC, 0xCF, 0xD1, 0xD4, 0xD6, 0xD8,
		0xDA, 0xDD, 0xDF, 0xE1, 0xE3, 0xE5, 0xE7, 0xE9, 0xEA, 0xEC, 0xEE, 0xEF, 0xF1, 0xF2, 0xF4, 0xF5,
		0xF6, 0xF7, 0xF8, 0xF9, 0xFA, 0xFB, 0xFC, 0xFD, 0xFD, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFD, 0xFD, 0xFC, 0xFB, 0xFA, 0xF9, 0xF8, 0xF7, 0xF6,
		0xF5, 0xF4, 0xF2, 0xF1, 0xEF, 0xEE, 0xEC, 0xEA, 0xE9, 0xE7, 0xE5, 0xE3, 0xE1, 0xDF, 0xDD, 0xDA,
		0xD8, 0xD6, 0xD4, 0xD1, 0xCF, 0xCC, 0xCA, 0xC7, 0xC5, 0xC2, 0xBF, 0xBC, 0xBA, 0xB7, 0xB4, 0xB1,
		0xAE, 0xAB, 0xA8, 0xA5, 0xA2, 0x9F, 0x9C, 0x99, 0x96, 0x93, 0x90, 0x8D, 0x89, 0x86, 0x83, 0x80,
		0x80, 0x7C, 0x79, 0x76, 0x72, 0x6F, 0x6C, 0x69, 0x66, 0x63, 0x60, 0x5D, 0x5A, 0x57, 0x55, 0x51,
		0x4E, 0x4C, 0x48, 0x45, 0x43, 0x40, 0x3D, 0x3A, 0x38, 0x35, 0x33, 0x30, 0x2E, 0x2B, 0x29, 0x27,
		0x25, 0x22, 0x20, 0x1E, 0x1C, 0x1A, 0x18, 0x16, 0x15, 0x13, 0x11, 0x10, 0x0E, 0x0D, 0x0B, 0x0A,
		0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
		0x0A, 0x0B, 0x0D, 0x0E, 0x10, 0x11, 0x13, 0x15, 0x16, 0x18, 0x1A, 0x1C, 0x1E, 0x20, 0x22, 0x25,
		0x27, 0x29, 0x2B, 0x2E, 0x30, 0x33, 0x35, 0x38, 0x3A, 0x3D, 0x40, 0x43, 0x45, 0x48, 0x4C, 0x4E,
		0x51, 0x55, 0x57, 0x5A, 0x5D, 0x60, 0x63, 0x66, 0x69, 0x6C, 0x6F, 0x72, 0x76, 0x79, 0x7C, 0x7E};

void stair(unsigned char i); //锯齿波

void square(unsigned char i); //方波
void trian(unsigned char i);  //三角波
void sin(unsigned char i);	//正弦波
void scan(unsigned char i);   //扫描函数
void Timer0Init(void);		  
unsigned char flag = 0;

void main()
{
	P2 = 0xff;
	Timer0Init();
	while (1)
	{

	}
}

void Timer0Init(void)
{

	TMOD = 0x02;			 //设置定时器模式 方式2自动重载
	TH0 = (256 - DATA_TIME); //设置定时初值
	TL0 = (256 - DATA_TIME); //设置定时初值
	ET0 = 1;				 //TF0标志
	TR0 = 1;				 //定时器0开始计时
	EA = 1;
}
void timer0_ISR(void) interrupt 1
{
	static unsigned char data_count = 0;

	if (data_count > 127)
		data_count = 0;
	scan((data_count << 1));
	data_count++;
}

void scan(unsigned char i)
{
	if ((0 == S1) && (0 == S2))
		stair(i);
	else if ((1 == S1) && (0 == S2))
		square(i);
	else if ((0 == S1) && (1 == S2))
		trian(i);
	else
		sin(i);
}
void stair(unsigned char i)
{
	DA0832 = i;
}

void square(unsigned char i)
{
	if (i <= 127)
	{
		DA0832 = 0xff;
	}
	else
	{
		DA0832 = 0x00;
	}
}

void trian(unsigned char i)
{
	if (i <= 127)
	{
		DA0832 = i << 1;
	}
	else
	{
		DA0832 = (255 - i) << 1;
	}
}

void sin(unsigned char i)
{
	DA0832 = sin_tab[i];
}
